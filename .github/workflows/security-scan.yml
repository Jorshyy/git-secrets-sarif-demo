name: git-secrets SARIF scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  security-events: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install git-secrets
        run: |
          git clone https://github.com/awslabs/git-secrets.git
          cd git-secrets
          sudo make install

      - name: Configure git-secrets patterns
        run: |
          git secrets --register-aws
          git secrets --add 'DB_PASSWORD'
          git secrets --add 'API_TOKEN'
          git secrets --add 'PRIVATE_KEY'
          echo "=== git-secrets config ==="
          git secrets --list || true

      - name: Run git-secrets scan and save output
        run: |
          # Optional: show what patterns are configured
          git secrets --list || true

          # Scan the repository; matches go to stdout
          git secrets --scan > git-secrets-output.txt || true

          echo "Scan complete, saved to git-secrets-output.txt"
          echo "===== git-secrets-output.txt ====="
          cat git-secrets-output.txt || echo "No output file created"


      - name: Convert git-secrets output to SARIF
        uses: Jorshyy/git-secrets-sarif-action@v1
        with:
          input-file: git-secrets-output.txt
          output-file: git-secrets-output.sarif

      - name: Debug SARIF
        run: |
          echo "==== SARIF file ===="
          cat git-secrets-output.sarif || echo "SARIF file missing"

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: git-secrets-output.sarif
